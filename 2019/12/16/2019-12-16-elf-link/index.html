<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="..1. 目录   ..1. 目录 ..2. 准备工具和基础汇编知识 ..3. 编译链接过程的基本原理和流程 ..3.1. gcc中编译一个源文件可以拆分为4个部分 ..3.2. 编译单元(Translation environment), 编译的转换阶段 : ..3.3. PIC PIE 位置无关代码 ..3.4. GOT PLT 全局偏移表 链接过程表 ..3.5. 符号表和符号 ..">
<meta property="og:type" content="article">
<meta property="og:title" content="ELF静态链接过程和动态链接过程中的GOT表的作用">
<meta property="og:url" content="https://zsummer.github.io/2019/12/16/2019-12-16-elf-link/index.html">
<meta property="og:site_name" content="关于夏天的一切">
<meta property="og:description" content="..1. 目录   ..1. 目录 ..2. 准备工具和基础汇编知识 ..3. 编译链接过程的基本原理和流程 ..3.1. gcc中编译一个源文件可以拆分为4个部分 ..3.2. 编译单元(Translation environment), 编译的转换阶段 : ..3.3. PIC PIE 位置无关代码 ..3.4. GOT PLT 全局偏移表 链接过程表 ..3.5. 符号表和符号 ..">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-12-15T16:00:00.000Z">
<meta property="article:modified_time" content="2020-03-09T03:25:56.826Z">
<meta property="article:author" content="夏天">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zsummer.github.io/2019/12/16/2019-12-16-elf-link/"/>





  <title>ELF静态链接过程和动态链接过程中的GOT表的作用 | 关于夏天的一切</title>
  














<meta name="generator" content="Hexo 4.2.1"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">关于夏天的一切</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">我总觉得对你的爱很美</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://zsummer.github.io/2019/12/16/2019-12-16-elf-link/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="夏天">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="关于夏天的一切">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ELF静态链接过程和动态链接过程中的GOT表的作用</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-12-16T00:00:00+08:00">
                2019-12-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/develop/" itemprop="url" rel="index">
                    <span itemprop="name">develop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <font color="#ff6688">  

<h3><span id="1-目录">..1. 目录</span></h3><!-- TOC -->

<ul>
<li><a href="#1-目录">..1. 目录</a></li>
<li><a href="#2-准备工具和基础汇编知识">..2. 准备工具和基础汇编知识</a></li>
<li><a href="#3-编译链接过程的基本原理和流程">..3. 编译链接过程的基本原理和流程</a><ul>
<li><a href="#31-gcc中编译一个源文件可以拆分为4个部分">..3.1. gcc中编译一个源文件可以拆分为4个部分</a></li>
<li><a href="#32-编译单元translation-environment-编译的转换阶段-">..3.2. 编译单元(Translation environment), 编译的转换阶段 :</a></li>
<li><a href="#33-pic-pie-位置无关代码">..3.3. PIC PIE 位置无关代码</a></li>
<li><a href="#34-got-plt-全局偏移表-链接过程表">..3.4. GOT PLT 全局偏移表 链接过程表</a></li>
<li><a href="#35-符号表和符号">..3.5. 符号表和符号</a><ul>
<li><a href="#351-全局符号和局部符号">..3.5.1. 全局符号和局部符号</a></li>
<li><a href="#352-外部符号和内部符号">..3.5.2. 外部符号和内部符号</a></li>
<li><a href="#353-和字符串表的关系">..3.5.3. 和字符串表的关系</a></li>
</ul>
</li>
<li><a href="#36-静态链接过程">..3.6. 静态链接过程</a></li>
<li><a href="#37-动态链接过程">..3.7. 动态链接过程</a></li>
</ul>
</li>
<li><a href="#4-跟踪调测">..4. 跟踪调测</a><ul>
<li><a href="#41-测试源码">..4.1. 测试源码</a></li>
<li><a href="#42-位置有关的重定位分析">..4.2. 位置有关的重定位分析</a><ul>
<li><a href="#421-分析结论如下">..4.2.1. 分析结论如下:</a></li>
<li><a href="#422-系统源码参考">..4.2.2. 系统源码参考:</a></li>
<li><a href="#423-字符串数据">..4.2.3. 字符串数据</a></li>
<li><a href="#424-节信息">..4.2.4. 节信息</a></li>
<li><a href="#425-text数据">..4.2.5. text数据</a></li>
</ul>
</li>
<li><a href="#43-位置无关的重定位分析">..4.3. 位置无关的重定位分析</a><ul>
<li><a href="#431-分析说明">..4.3.1. 分析说明</a></li>
<li><a href="#432-全局数据访问代码分析">..4.3.2. 全局数据访问代码分析</a></li>
<li><a href="#433-全局函数访问代码分析">..4.3.3. 全局函数访问代码分析</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#动态库装载过程">动态库装载过程</a><ul>
<li><a href="#elf的辅助向量-auxv">ELF的辅助向量 AUXV</a></li>
<li><a href="#load_elf_binary函数">load_elf_binary函数</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->

<h3><span id="2-准备工具和基础汇编知识">..2. 准备工具和基础汇编知识</span></h3><ul>
<li>readelf -a  查看elf信息  </li>
<li>objdump -S 查看汇编指令  </li>
<li>ldd 查看动态加载   </li>
<li>xxd - make a hexdump or do the reverse.</li>
<li>gdb  <ul>
<li>gdb 通过<code>layout regs</code>打开寄存器显示, 通过<code>set disassemble-next-line on</code>打开汇编  </li>
<li>gdb 通过peda插件字节显示汇编和寄存器  和上面的原生方式选择一个即可    </li>
<li>gdb关闭ASLR：<ul>
<li>set disable-randomization on</li>
</ul>
</li>
<li>开启ASLR：<ul>
<li>set disable-randomization off</li>
</ul>
</li>
<li>查看ASLR状态：<ul>
<li>show disable-randomization</li>
</ul>
</li>
<li>disas反汇编命令，直接disas是反汇编当前函数<ul>
<li>disas /r (显示汇编指令对应十六进制值)   </li>
<li>disas /m (如果有源码，显示对应行源码)   </li>
</ul>
</li>
<li>intel语法<ul>
<li>set disassembly-flavor intel</li>
<li>set disassembly-flavor att  </li>
</ul>
</li>
</ul>
</li>
<li>详细工具和汇编的基础知识见上一篇文章: <a href="https://zsummer.github.io/2019/12/11/2019-12-11-asm-syntax/">汇编语法/寻址/寄存器/代码模型(GNU assembler) </a>  </li>
</ul>
<a id="more"></a>

<h3><span id="3-编译链接过程的基本原理和流程">..3. 编译链接过程的基本原理和流程</span></h3><p>C和C++均使用分离编译来支持多源文件模块化机制, 因此也带来了静态和动态的链接问题, 本文主要梳理了静态库的链接过程和动态链接过程.    </p>
<h4><span id="31-gcc中编译一个源文件可以拆分为4个部分">..3.1. gcc中编译一个源文件可以拆分为4个部分</span></h4><ol>
<li>预处理 -E</li>
<li>编译器 -S</li>
<li>目标文件 -C</li>
<li>链接为共享库或者可执行程序   </li>
</ol>
<h4><span id="32-编译单元translation-environment-编译的转换阶段">..3.2. 编译单元(Translation environment), 编译的转换阶段 :</span></h4><blockquote>
<p>[ISO/IEC 9899:1999]A C program need not all be translated at the same time.The text of the program is kept in units called source files, (or preprocessing files) in this International Standard.A source file together with all the headers and source files included via the preprocessing directive #include is known as a preprocessing translation unit. After preprocessing, a preprocessing translation unit is called a translation unit.<br>Previously translated translation units may be preserved individually or in libraries. The separate translation units of a program communicate by (for example) calls to functions whose identifiers have external linkage, manipulation of objects whose identifiers have external linkage, or manipulation of data files. Translation units may be separately translated and then later linked to produce an executable program.  </p>
</blockquote>
<blockquote>
<p>C语言的程序不需要一同时间翻译, 在这个国际标准中, 程序的文本内容以源文件(或者预处理文件)为单位保存, 一个源文件连同所有通过预处理指令#include包含的头文件和源文件被称为预处理翻译单元, 经过预处理后的翻译单元称为翻译单元.  翻译单位可以单独保存，也可以打包在程序库里. 程序的独立翻译单元通过(例如) 调用具有外部链接标识的函数, 处理具有外部链接标识的对象完成连接过程.  翻译单元可以独立翻译然后通过链接生成可执行程序.   </p>
</blockquote>
<h4><span id="33-pic-pie-位置无关代码">..3.3. PIC PIE 位置无关代码</span></h4><p>编译出的二进制指令不使用绝对地址而使用相对地址称为PIC 技术<br>PIE和PIC的区别在于PIE假定了代码最终会被直接链接为可执行程序    </p>
<h4><span id="34-got-plt-全局偏移表-链接过程表">..3.4. GOT PLT 全局偏移表 链接过程表</span></h4><p>这两个表完成了上面<a href="#编译单元translation-environment-编译的转换阶段-">编译单元</a>中所说的处理过程  </p>
<h4><span id="35-符号表和符号">..3.5. 符号表和符号</span></h4><h5><span id="351-全局符号和局部符号">..3.5.1. 全局符号和局部符号</span></h5><p>符号的全局和局部是相对于编译单元而言的,  例如添加了static前缀的全局变量或者函数只在当前的编译单元可见, 因此是局部的 .<br>重定位不关心局部符号,  而对于在函数内声明的局部变量的名字并不会存储到符号表 完全由运行时栈来维护,(-g选项可以在.debug中找到符号).<br>符号表是为了编译单元之间建立联系使用的, 比如重定位.   </p>
<h5><span id="352-外部符号和内部符号">..3.5.2. 外部符号和内部符号</span></h5><p>外部符号是指的当前编译单元使用但是却不在当前编译单元定义的符号.   </p>
<h5><span id="353-和字符串表的关系">..3.5.3. 和字符串表的关系</span></h5><p>符号表的name字段是字符串表的索引,  也就是说, 符号表本身并不存储符号的’字符串’名.<br>字符串表除了保存符号名外, 还保存常量字符串的值  </p>
<h4><span id="36-静态链接过程">..3.6. 静态链接过程</span></h4><ol>
<li>编译阶段  <ol>
<li>建立字符串表,符号表, 保存符号对应的声明信息.  </li>
<li>建立重定位表, 对全局符号的访问都标记出准确的偏移地址  </li>
</ol>
</li>
<li>链接生成阶段  <ol>
<li>合并目标文件中相同的节, 确定虚拟内存地址(pic技术只确定相对地址)  </li>
<li>重建重定位表和符号表   </li>
<li>使用重定位表和符号表中记录的数据对代码段和数据段进行修改.   </li>
</ol>
</li>
<li>运行时  <ol>
<li>所有地址已经完成重定位 对全局符号的访问不存在中间过程   </li>
<li>如果未非位置无关代码, 则对全局符号的访问为立即数即为分配好的实际地址  </li>
<li>如果是位置无关代码, 则对全局符号的访问需要用rip计算相对偏移.  </li>
</ol>
</li>
</ol>
<h4><span id="37-动态链接过程">..3.7. 动态链接过程</span></h4><p>动态链接和静态链接的区别在于, 动态链接把重定位的时机放在了动态库被加载到内存之后.    </p>
<ol>
<li>编译阶段  <ol>
<li>建立字符串表,符号表, 保存符号对应的声明信息.  </li>
<li>建立重定位表, 对全局符号的访问都标记出准确的偏移地址  </li>
</ol>
</li>
<li>链接生成阶段  <ol>
<li>合并目标文件中相同的节  确定虚拟内存地址(pic技术只确定相对地址)  </li>
<li>重建重定位表和符号表   </li>
<li>使用重定位表和符号表中记录的数据对代码段和数据段进行修改.   </li>
<li>保存全局符号到动态符号表(符号表中有全部符号数据 此为优化)   </li>
<li>建立动态重定位表, 对全局变量的访问走GOT表, 动态重定位表记录了符号名和对应数据段中的编号(该数据段被标记为.got节).  </li>
<li>建立链接过程表, 对全局函数的访问生成plt代码(.plt), 链接过程重定位表(.rela.plt)记录了每个全局函数的符号名以及在保存实际函数地址的数据段的地址. (.got.plt节), .got.plt表中存储的指针默认是   <ol>
<li>.got.plt中所有函数的地址都会默认保存为第 个元素的内容, 该地址为_dl_runtime_resolve , 通过符号表找到真正的函数地址后填充.got.plt并执行函数.    </li>
</ol>
</li>
<li>对于内部符号的访问是否会进行优化 取决于代码模型,  例如对于小型代码模型中, 可执行程序中会直接访问全局变量的地址(被优化,但仍然保留GOT机制的有效性). 但是共享库中对全局变量的访问即使是当前库中的也一定会走got表.   </li>
</ol>
</li>
<li>运行时  <ol>
<li>加载共享库   <ol>
<li>完成got, got.plt的填充   </li>
<li>如果有repolr技术则设置内存段的只读  </li>
</ol>
</li>
<li>运行过程中  <ol>
<li>对全局变量的访问需要通过got表找到真正的地址   </li>
<li>对函数的访问每次都会走plt, 第一次访问会跳转到符号解析函数找到真正的函数地址, 后续plt则会省略解析流程, 此为惰性加载机制.  </li>
</ol>
</li>
</ol>
</li>
</ol>
<!-- more -->

<h3><span id="4-跟踪调测">..4. 跟踪调测</span></h3><p>编译选项为</p>
<ul>
<li>位置无关代码   </li>
<li>禁止优化   </li>
<li>禁止假设代码模型   </li>
</ul>
<h4><span id="41-测试源码">..4.1. 测试源码</span></h4><p>lib.cpp  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int g_static_lib_bss &#x3D; 0;</span><br><span class="line">int g_static_lib_data &#x3D; 100;</span><br><span class="line">int lib_func(int a, int b)</span><br><span class="line">&#123;</span><br><span class="line">  return a+b + g_static_lib_bss + g_static_lib_data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>so.cpp  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">int lib_func(int a, int b);</span><br><span class="line">extern long long g_static_lib_bss;</span><br><span class="line">extern long long g_static_lib_data;</span><br><span class="line">long long g_static_so_bss &#x3D; 0;</span><br><span class="line">long long g_static_so_data &#x3D; 100000;</span><br><span class="line"></span><br><span class="line">static long long g_local_so_data &#x3D; 0xff00ff00;</span><br><span class="line"></span><br><span class="line">int so_child_func(int a, int b)</span><br><span class="line">&#123;</span><br><span class="line">  return a+b + g_static_so_bss + g_static_so_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int so_local_func()</span><br><span class="line">&#123;</span><br><span class="line">  return g_local_so_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int so_func(int a, int b)</span><br><span class="line">&#123;</span><br><span class="line">  g_static_so_bss ++;</span><br><span class="line">  g_static_so_data ++;</span><br><span class="line">  int ret &#x3D; lib_func(g_static_so_bss, g_static_so_data);</span><br><span class="line">  ret +&#x3D; so_child_func(g_static_lib_data, g_static_lib_bss);</span><br><span class="line">  ret +&#x3D; so_local_func();</span><br><span class="line">  return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>main.cpp  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">int so_child_func(int a, int b);</span><br><span class="line">int so_func(int a, int b);</span><br><span class="line">extern int g_static_so_bss;</span><br><span class="line">extern int g_static_so_data;</span><br><span class="line"></span><br><span class="line">int g_main_static[128*1024] &#x3D; &#123;2,1&#125;;</span><br><span class="line"></span><br><span class="line">int main_func(int a, int b)</span><br><span class="line">&#123;</span><br><span class="line">   int c &#x3D; a+b;</span><br><span class="line">   c +&#x3D; g_static_so_bss;</span><br><span class="line">   c +&#x3D; g_static_so_data;</span><br><span class="line">   c +&#x3D; g_main_static[0];</span><br><span class="line">   c +&#x3D; so_func(a, b);</span><br><span class="line">   return c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[])</span><br><span class="line">&#123;</span><br><span class="line">   int a &#x3D; 0;</span><br><span class="line">   g_static_so_bss &#x3D; 1000000;</span><br><span class="line">   a +&#x3D; main_func(argc, 1);</span><br><span class="line">   return a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4><span id="42-位置有关的重定位分析">..4.2. 位置有关的重定位分析</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">g++ -c so.cpp  -O0 -mcmodel&#x3D;large  -fno-pic  </span><br><span class="line">g++ -c lib.cpp  -O0 -mcmodel&#x3D;large  -fno-pic </span><br><span class="line">g++ -c main.cpp  -O0 -mcmodel&#x3D;large  -fno-pic </span><br><span class="line">g++ so.o lib.o main.o -O0 -mcmodel&#x3D;large -no-pie</span><br></pre></td></tr></table></figure>

<h5><span id="421-分析结论如下">..4.2.1. 分析结论如下:</span></h5><ul>
<li><p>so.cpp中所有非static的全局变量和函数都存在符号表中  </p>
<ul>
<li>符号表的起始偏移为00000200 大小为198</li>
<li>字符串表的起始偏移为00000398 大小为a4  </li>
</ul>
</li>
<li><p>通过xxd命令可以观察到存储所有所有符号名的位置为 0x398处开始分别是字符串:</p>
<ul>
<li>null</li>
<li>so.cpp</li>
<li>_ZL15g_local_so_data</li>
<li>…</li>
</ul>
</li>
<li><p>字符串表中的字符串均为标准的c-style风格的null为结尾(0x00)的字符串   </p>
</li>
<li><p>符号表的所在位置0x00000200则为规整的数组 没有字符串信息  </p>
</li>
<li><p>局部变量出现在目标对象的符号表中但对其访问的代码位置未出现在重定位表中  </p>
</li>
<li><p>局部变量在符号中的类型是LOCAL  </p>
</li>
<li><p>无论外部符号还是内部符号, 对于全局符号的访问均在重定位表中指明了具体的符号和偏移数据    </p>
</li>
<li><p>R_X86_64_64类型或者PC类型均为直接修改访问代码来完成重定位  </p>
</li>
<li><p>对于外部的符号 无论是函数还是数据 在符号表中 均为<code>NOTYPE  GLOBAL UND</code>的一行占位数据  </p>
</li>
<li><p>对于内部定义的全局函数, 则记录了再文本节中的具体的地址偏移,大小,类型等信息.   </p>
</li>
<li><p>对于内部定义的全局变量, 则记录了该变量的序号, 大小, 类型信息.   </p>
</li>
<li><p>.data字段为16字节 内容分别是 a086 0100 0000 0000, 00ff 00ff 0000 0000</p>
<ul>
<li>对应为long long g_static_so_data = 100000; 和static long long g_local_so_data = 0xff00ff00;</li>
</ul>
</li>
</ul>
<p>访问全局数据  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int so_func(int a, int b)</span><br><span class="line">&#123;</span><br><span class="line">  g_static_so_bss ++;</span><br></pre></td></tr></table></figure>
<p>这里的g_static_so_bss 对应的汇编为:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">55:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">5c:   00 00 00 </span><br><span class="line">5f:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">62:   48 8d 50 01             lea    0x1(%rax),%rdx</span><br></pre></td></tr></table></figure>
<p>其意思是  </p>
<ul>
<li>用64位立即数0来设置rax寄存器  </li>
<li>解引用rax 并把内容保存到rax寄存器   </li>
<li>rax的内容+1 (这里利用了lea寻址完成++)并保存到rdx寄存器<br>这里问题就来了, 用C语言来描述就是  我们对地址 为0的的指针当做真实的全局变量的地址进行了解引用.   </li>
</ul>
<p>那么我们看下经过链接后的该汇编代码:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">4005d3:       48 b8 60 10 68 00 00    movabs $0x681060,%rax</span><br><span class="line">4005da:       00 00 00 </span><br><span class="line">4005dd:       48 8b 00                mov    (%rax),%rax</span><br><span class="line">4005e0:       48 8d 50 01             lea    0x1(%rax),%rdx</span><br></pre></td></tr></table></figure>
<p>在这里, 这个立即数已经变成了合并完.data后, g_static_so_bss的真实地址.<br>这个立即数指令所在的地址偏移为0x57 然后我们查看重定位表即可发现完成该过程所需要的重定位信息:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">000000000057  000a00000001 R_X86_64_64       0000000000000000 g_static_so_bss + 0</span><br></pre></td></tr></table></figure>

<p>备注:<br>这里我们看到最终链接出的地址4005da: 说明该程序并非pic代码, 对全局变量的访问没有任何相对计算以及读表过程.    </p>
<h5><span id="422-系统源码参考">..4.2.2. 系统源码参考:</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* $begin elfsymbol *&#x2F;</span><br><span class="line">typedef struct &#123; </span><br><span class="line">    int   name;      &#x2F;* String table offset *&#x2F; </span><br><span class="line">    char  type:4,    &#x2F;* Function or data (4 bits) *&#x2F; </span><br><span class="line">    binding:4; &#x2F;* Local or global (4 bits) *&#x2F; </span><br><span class="line">    char  reserved;  &#x2F;* Unused *&#x2F;  </span><br><span class="line">    short section;   &#x2F;* Section header index *&#x2F;</span><br><span class="line">    long  value;     &#x2F;* Section offset or absolute address *&#x2F; </span><br><span class="line">    long  size;      &#x2F;* Object size in bytes *&#x2F; </span><br><span class="line">&#125; Elf64_Symbol; </span><br><span class="line">&#x2F;* $end elfsymbol *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;* $begin elfrelo *&#x2F;</span><br><span class="line">typedef struct &#123; </span><br><span class="line">    long offset;    &#x2F;* Offset of the reference to relocate *&#x2F; </span><br><span class="line">    long type:32,   &#x2F;* Relocation type *&#x2F; </span><br><span class="line">    symbol:32; &#x2F;* Symbol table index *&#x2F; </span><br><span class="line">    long addend;    &#x2F;* Constant part of relocation expression *&#x2F;</span><br><span class="line">&#125; Elf64_Rela; </span><br><span class="line">&#x2F;* $end elfrelo *&#x2F;</span><br></pre></td></tr></table></figure>


<h5><span id="423-字符串数据">..4.2.3. 字符串数据</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">00000390: 0000 0000 0000 0000 0073 6f2e 6370 7000  .........so.cpp.</span><br><span class="line">000003a0: 5f5a 4c31 3567 5f6c 6f63 616c 5f73 6f5f  _ZL15g_local_so_</span><br><span class="line">000003b0: 6461 7461 005f 5a4c 3133 736f 5f6c 6f63  data._ZL13so_loc</span><br><span class="line">000003c0: 616c 5f66 756e 6376 0067 5f73 7461 7469  al_funcv.g_stati</span><br><span class="line">000003d0: 635f 736f 5f62 7373 0067 5f73 7461 7469  c_so_bss.g_stati</span><br><span class="line">000003e0: 635f 736f 5f64 6174 6100 5f5a 3133 736f  c_so_data._Z13so</span><br><span class="line">000003f0: 5f63 6869 6c64 5f66 756e 6369 6900 5f5a  _child_funcii._Z</span><br><span class="line">00000400: 3773 6f5f 6675 6e63 6969 005f 5a38 6c69  7so_funcii._Z8li</span><br><span class="line">00000410: 625f 6675 6e63 6969 0067 5f73 7461 7469  b_funcii.g_stati</span><br><span class="line">00000420: 635f 6c69 625f 6273 7300 675f 7374 6174  c_lib_bss.g_stat</span><br><span class="line">00000430: 6963 5f6c 6962 5f64 6174 6100 0000 0000  ic_lib_data.....</span><br></pre></td></tr></table></figure>


<h5><span id="424-节信息">..4.2.4. 节信息</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">ELF 头：</span><br><span class="line">  Magic：  7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  类别:                              ELF64</span><br><span class="line">  数据:                              2 补码，小端序 (little endian)</span><br><span class="line">  版本:                              1 (current)</span><br><span class="line">  OS&#x2F;ABI:                            UNIX - System V</span><br><span class="line">  ABI 版本:                          0</span><br><span class="line">  类型:                              REL (可重定位文件)</span><br><span class="line">  系统架构:                          Advanced Micro Devices X86-64</span><br><span class="line">  版本:                              0x1</span><br><span class="line">  入口点地址：              0x0</span><br><span class="line">  程序头起点：              0 (bytes into file)</span><br><span class="line">  Start of section headers:          1592 (bytes into file)</span><br><span class="line">  标志：             0x0</span><br><span class="line">  本头的大小：       64 (字节)</span><br><span class="line">  程序头大小：       0 (字节)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  节头大小：         64 (字节)</span><br><span class="line">  节头数量：         12</span><br><span class="line">  字符串表索引节头： 11</span><br><span class="line"></span><br><span class="line">节头：</span><br><span class="line">  [号] 名称              类型             地址              偏移量</span><br><span class="line">       大小              全体大小          旗标   链接   信息   对齐</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       0000000000000103  0000000000000000  AX       0     0     1</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000440</span><br><span class="line">       0000000000000150  0000000000000018   I       9     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  00000148</span><br><span class="line">       0000000000000010  0000000000000000  WA       0     0     8</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  00000158</span><br><span class="line">       0000000000000008  0000000000000000  WA       0     0     8</span><br><span class="line">  [ 5] .comment          PROGBITS         0000000000000000  00000158</span><br><span class="line">       000000000000002e  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 6] .note.GNU-stack   PROGBITS         0000000000000000  00000186</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 7] .eh_frame         PROGBITS         0000000000000000  00000188</span><br><span class="line">       0000000000000078  0000000000000000   A       0     0     8</span><br><span class="line">  [ 8] .rela.eh_frame    RELA             0000000000000000  00000590</span><br><span class="line">       0000000000000048  0000000000000018   I       9     7     8</span><br><span class="line">  [ 9] .symtab           SYMTAB           0000000000000000  00000200</span><br><span class="line">       0000000000000198  0000000000000018          10    10     8</span><br><span class="line">  [10] .strtab           STRTAB           0000000000000000  00000398</span><br><span class="line">       00000000000000a4  0000000000000000           0     0     1</span><br><span class="line">  [11] .shstrtab         STRTAB           0000000000000000  000005d8</span><br><span class="line">       0000000000000059  0000000000000000           0     0     1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  l (large), p (processor specific)</span><br><span class="line"></span><br><span class="line">There are no section groups in this file.</span><br><span class="line"></span><br><span class="line">本文件中没有程序头。</span><br><span class="line"></span><br><span class="line">重定位节 &#39;.rela.text&#39; 位于偏移量 0x440 含有 14 个条目：</span><br><span class="line">  偏移量          信息           类型           符号值        符号名称 + 加数</span><br><span class="line">000000000016  000a00000001 R_X86_64_64       0000000000000000 g_static_so_bss + 0</span><br><span class="line">000000000025  000b00000001 R_X86_64_64       0000000000000000 g_static_so_data + 0</span><br><span class="line">00000000003a  000300000001 R_X86_64_64       0000000000000000 .data + 8</span><br><span class="line">000000000057  000a00000001 R_X86_64_64       0000000000000000 g_static_so_bss + 0</span><br><span class="line">000000000068  000a00000001 R_X86_64_64       0000000000000000 g_static_so_bss + 0</span><br><span class="line">000000000075  000b00000001 R_X86_64_64       0000000000000000 g_static_so_data + 0</span><br><span class="line">000000000086  000b00000001 R_X86_64_64       0000000000000000 g_static_so_data + 0</span><br><span class="line">000000000093  000b00000001 R_X86_64_64       0000000000000000 g_static_so_data + 0</span><br><span class="line">0000000000a2  000a00000001 R_X86_64_64       0000000000000000 g_static_so_bss + 0</span><br><span class="line">0000000000b3  000e00000001 R_X86_64_64       0000000000000000 _Z8lib_funcii + 0</span><br><span class="line">0000000000c2  000f00000001 R_X86_64_64       0000000000000000 g_static_lib_bss + 0</span><br><span class="line">0000000000d1  001000000001 R_X86_64_64       0000000000000000 g_static_lib_data + 0</span><br><span class="line">0000000000e2  000c00000001 R_X86_64_64       0000000000000000 _Z13so_child_funcii + 0</span><br><span class="line">0000000000f1  000200000001 R_X86_64_64       0000000000000000 .text + 34</span><br><span class="line"></span><br><span class="line">重定位节 &#39;.rela.eh_frame&#39; 位于偏移量 0x590 含有 3 个条目：</span><br><span class="line">  偏移量          信息           类型           符号值        符号名称 + 加数</span><br><span class="line">000000000020  000200000002 R_X86_64_PC32     0000000000000000 .text + 0</span><br><span class="line">000000000040  000200000002 R_X86_64_PC32     0000000000000000 .text + 34</span><br><span class="line">000000000060  000200000002 R_X86_64_PC32     0000000000000000 .text + 47</span><br><span class="line"></span><br><span class="line">The decoding of unwind sections for machine type Advanced Micro Devices X86-64 is not currently supported.</span><br><span class="line"></span><br><span class="line">Symbol table &#39;.symtab&#39; contains 17 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS so.cpp</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 </span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 </span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 </span><br><span class="line">     5: 0000000000000008     8 OBJECT  LOCAL  DEFAULT    3 _ZL15g_local_so_data</span><br><span class="line">     6: 0000000000000034    19 FUNC    LOCAL  DEFAULT    1 _ZL13so_local_funcv</span><br><span class="line">     7: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 </span><br><span class="line">     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    7 </span><br><span class="line">     9: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 </span><br><span class="line">    10: 0000000000000000     8 OBJECT  GLOBAL DEFAULT    4 g_static_so_bss</span><br><span class="line">    11: 0000000000000000     8 OBJECT  GLOBAL DEFAULT    3 g_static_so_data</span><br><span class="line">    12: 0000000000000000    52 FUNC    GLOBAL DEFAULT    1 _Z13so_child_funcii</span><br><span class="line">    13: 0000000000000047   188 FUNC    GLOBAL DEFAULT    1 _Z7so_funcii</span><br><span class="line">    14: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _Z8lib_funcii</span><br><span class="line">    15: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND g_static_lib_bss</span><br><span class="line">    16: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND g_static_lib_data</span><br><span class="line"></span><br><span class="line">No version information found in this file.</span><br></pre></td></tr></table></figure>

<h5><span id="425-text数据">..4.2.5. text数据</span></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">so.o：     文件格式 elf64-x86-64   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:    </span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;_Z13so_child_funcii&gt;:</span><br><span class="line">   0:   55                      push   %rbp</span><br><span class="line">   1:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">   4:   89 7d fc                mov    %edi,-0x4(%rbp)</span><br><span class="line">   7:   89 75 f8                mov    %esi,-0x8(%rbp)</span><br><span class="line">   a:   8b 55 fc                mov    -0x4(%rbp),%edx</span><br><span class="line">   d:   8b 45 f8                mov    -0x8(%rbp),%eax</span><br><span class="line">  10:   01 d0                   add    %edx,%eax</span><br><span class="line">  12:   89 c2                   mov    %eax,%edx</span><br><span class="line">  14:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  1b:   00 00 00 </span><br><span class="line">  1e:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  21:   01 c2                   add    %eax,%edx</span><br><span class="line">  23:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  2a:   00 00 00 </span><br><span class="line">  2d:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  30:   01 d0                   add    %edx,%eax</span><br><span class="line">  32:   5d                      pop    %rbp</span><br><span class="line">  33:   c3                      retq   </span><br><span class="line"></span><br><span class="line">0000000000000034 &lt;_ZL13so_local_funcv&gt;:</span><br><span class="line">  34:   55                      push   %rbp</span><br><span class="line">  35:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  38:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  3f:   00 00 00 </span><br><span class="line">  42:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  45:   5d                      pop    %rbp</span><br><span class="line">  46:   c3                      retq   </span><br><span class="line"></span><br><span class="line">0000000000000047 &lt;_Z7so_funcii&gt;:</span><br><span class="line">  47:   55                      push   %rbp</span><br><span class="line">  48:   48 89 e5                mov    %rsp,%rbp</span><br><span class="line">  4b:   48 83 ec 20             sub    $0x20,%rsp</span><br><span class="line">  4f:   89 7d ec                mov    %edi,-0x14(%rbp)</span><br><span class="line">  52:   89 75 e8                mov    %esi,-0x18(%rbp)</span><br><span class="line">  55:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  5c:   00 00 00 </span><br><span class="line">  5f:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  62:   48 8d 50 01             lea    0x1(%rax),%rdx</span><br><span class="line">  66:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  6d:   00 00 00 </span><br><span class="line">  70:   48 89 10                mov    %rdx,(%rax)</span><br><span class="line">  73:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  7a:   00 00 00 </span><br><span class="line">  7d:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  80:   48 8d 50 01             lea    0x1(%rax),%rdx</span><br><span class="line">  84:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  8b:   00 00 00 </span><br><span class="line">  8e:   48 89 10                mov    %rdx,(%rax)</span><br><span class="line">  91:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  98:   00 00 00 </span><br><span class="line">  9b:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  9e:   89 c2                   mov    %eax,%edx</span><br><span class="line">  a0:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  a7:   00 00 00 </span><br><span class="line">  aa:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  ad:   89 d6                   mov    %edx,%esi</span><br><span class="line">  af:   89 c7                   mov    %eax,%edi</span><br><span class="line">  b1:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  b8:   00 00 00 </span><br><span class="line">  bb:   ff d0                   callq  *%rax</span><br><span class="line">  bd:   89 45 fc                mov    %eax,-0x4(%rbp)</span><br><span class="line">  c0:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  c7:   00 00 00 </span><br><span class="line">  ca:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  cd:   89 c2                   mov    %eax,%edx</span><br><span class="line">  cf:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  d6:   00 00 00 </span><br><span class="line">  d9:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">  dc:   89 d6                   mov    %edx,%esi</span><br><span class="line">  de:   89 c7                   mov    %eax,%edi</span><br><span class="line">  e0:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  e7:   00 00 00 </span><br><span class="line">  ea:   ff d0                   callq  *%rax</span><br><span class="line">  ec:   01 45 fc                add    %eax,-0x4(%rbp)</span><br><span class="line">  ef:   48 b8 00 00 00 00 00    movabs $0x0,%rax</span><br><span class="line">  f6:   00 00 00 </span><br><span class="line">  f9:   ff d0                   callq  *%rax</span><br><span class="line">  fb:   01 45 fc                add    %eax,-0x4(%rbp)</span><br><span class="line">  fe:   8b 45 fc                mov    -0x4(%rbp),%eax</span><br><span class="line"> 101:   c9                      leaveq </span><br><span class="line"> 102:   c3                      retq</span><br></pre></td></tr></table></figure>





<h4><span id="43-位置无关的重定位分析">..4.3. 位置无关的重定位分析</span></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">g++ -c so.cpp  -O0 -mcmodel&#x3D;large  -fPIC  </span><br><span class="line">g++ -c lib.cpp  -O0 -mcmodel&#x3D;large  -fPIC  </span><br><span class="line">g++ -c main.cpp  -O0 -mcmodel&#x3D;large  -fPIC  </span><br><span class="line">g++ -shared so.o  -O0 -mcmodel&#x3D;large  -fPIC  </span><br><span class="line">g++ so.so lib.o main.o -O0 -mcmodel&#x3D;large -pie -fPIE    </span><br><span class="line">export  LD_LIBRARY_PATH&#x3D;LD_LIBRARY_PATH:.&#x2F;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">g++-6 -c so.cpp  -O0 -mcmodel&#x3D;large  -fPIC  </span><br><span class="line">g++-6 -c lib.cpp  -O0 -mcmodel&#x3D;large  -fPIC  </span><br><span class="line">g++-6 -c main.cpp  -O0 -mcmodel&#x3D;large  -fPIC  </span><br><span class="line">g++-6 -shared so.o -oso.so  -O0 -mcmodel&#x3D;large  -fPIC  </span><br><span class="line">g++-6 so.so lib.o main.o -O0 -mcmodel&#x3D;large -pie -fPIE    </span><br><span class="line">export  LD_LIBRARY_PATH&#x3D;LD_LIBRARY_PATH:.&#x2F;</span><br></pre></td></tr></table></figure>

<h5><span id="431-分析说明">..4.3.1. 分析说明</span></h5><p>PIC的代码在编译为目标对象时, 所用的重定位方法和非PIC在方法上并没有差别  </p>
<blockquote>
<p>指明代码段中访问全局符号的操作数位置<br>在编译阶段用正确的地址替换掉占位用的空地址<br>与非PIC的差别我们会看到访问所有数据最终最终都会通过GOT表, 所以这部分的立即数会首先被替换成GOT表的地址<br>本段分析中主要分析动态链接的关键部分GOT/PLT/LOAD/FIXSYMBO部分分析, 对上述部分不再贴细节分析代码.   </p>
</blockquote>
<ul>
<li>so中的重定位表分别是.rela.dyn .rela.plt, 和目标文件中的记录格式类似但有明显不同  <ul>
<li>无论是对全局数据的访问还是对全局函数的访问, 其重定位的地址都不在是代码段中的位置, 而是位于数据段   <ul>
<li>对全局变量的访问, 重定位地址在.got段 数据段  </li>
<li>对全局函数的访问, 重定位地址在.got.plt段 数据段  </li>
</ul>
</li>
</ul>
</li>
<li>重定位不在涉及修改.txt段中的内容, 所以共享库的文本段是可以跨进程安全共享的  </li>
</ul>
<h5><span id="432-全局数据访问代码分析">..4.3.2. 全局数据访问代码分析</span></h5><p>访问全局数据  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int so_func(int a, int b)</span><br><span class="line">&#123;</span><br><span class="line">  g_static_so_bss ++;</span><br></pre></td></tr></table></figure>
<p>这里的g_static_so_bss++ 对应的汇编为:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">8a3:   48 8d 1d f9 ff ff ff    lea    -0x7(%rip),%rbx        # 8a3 &lt;_Z7so_funcii+0xb&gt;</span><br><span class="line">8aa:   49 bb 5d 07 20 00 00    movabs $0x20075d,%r11</span><br><span class="line">8b1:   00 00 00 </span><br><span class="line">8b4:   4c 01 db                add    %r11,%rbx</span><br><span class="line">8b7:   89 7d dc                mov    %edi,-0x24(%rbp)</span><br><span class="line">8ba:   89 75 d8                mov    %esi,-0x28(%rbp)</span><br><span class="line">8bd:   48 b8 e0 ff ff ff ff    movabs $0xffffffffffffffe0,%rax</span><br><span class="line">8c4:   ff ff ff </span><br><span class="line">8c7:   48 8b 04 03             mov    (%rbx,%rax,1),%rax</span><br><span class="line">8cb:   48 8b 00                mov    (%rax),%rax</span><br><span class="line">8ce:   48 8d 50 01             lea    0x1(%rax),%rdx</span><br></pre></td></tr></table></figure>
<p>其意思是  </p>
<ul>
<li>8a3这行指令+0x20075d偏移保存到%rbx  </li>
<li>计算出最终地址(%rbx + xffffffffffffffe0 (-20) * 1)并取值到rax  <ul>
<li>rbx的值为0x201000该地址对应的是节.got.plt 也是.got + sizeof(.got)的位置  </li>
<li>-20位则表示在.got中  最终的地址为0x200fe0  </li>
<li>查找.dyn表可以知道该位置为000000200fe0  g_static_so_bss + 0   </li>
<li>查看该位置的内存为0  </li>
<li>那么如果在运行时没有进行动态填充, 则这里会出现对地址0进行解引用的操作.   </li>
<li>rbx寄存器会复用 专门用来保存got表的入口偏移, 也就是浪费了一个通用寄存器来实现地址无关代码  </li>
</ul>
</li>
<li>我们进入gdb调试  </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7bd68a3    lea    -0x7(%rip),%rbx        # 0x7ffff7bd68a3 &lt;_Z7so_funcii+11&gt;   </span><br><span class="line">0x7ffff7bd68aa    movabs $0x20075d,%r11                 </span><br><span class="line">0x7ffff7bd68b4    add    %r11,%rbx                      </span><br><span class="line">0x7ffff7bd68b7    mov    %edi,-0x24(%rbp)               </span><br><span class="line">0x7ffff7bd68ba    mov    %esi,-0x28(%rbp)               </span><br><span class="line">0x7ffff7bd68bd    movabs $0xffffffffffffffe0,%rax       </span><br><span class="line">0x7ffff7bd68c7    mov    (%rbx,%rax,1),%rax             </span><br><span class="line">0x7ffff7bd68cb    mov    (%rax),%rax                    </span><br><span class="line">0x7ffff7bd68ce    lea    0x1(%rax),%rdx</span><br></pre></td></tr></table></figure>
<p>带入计算:  </p>
<figure class="highlight plain"><figcaption><span>+ 0x20075d + -20*1 </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">该位置位于加载so.so的内存中, 对应为只读的got表</span><br></pre></td></tr></table></figure>
<p>00007ffff7bd6000      4K r-x– so.so<br>00007ffff7bd7000   2044K —– so.so<br>00007ffff7dd6000      4K r—- so.so<br>00007ffff7dd7000      4K rw— so.so</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">推算got表在内存中的实际位置为 0x7FFFF7DD6FE0 - 28 &#x3D;  0x7FFFF7DD6FB8  </span><br><span class="line">那么查看该got实际的内存如下:</span><br></pre></td></tr></table></figure>
<p>(gdb) x /9ag 0x7FFFF7DD6FB8<br>0x7ffff7dd6fb8: 0x7ffff6f27c30 &lt;__cxa_finalize&gt;<br>0x7ffff7dd6fc0: 0x555555755030 <g_static_lib_data><br>0x7ffff7dd6fc8: 0x5555557d5044 <g_static_lib_bss><br>0x7ffff7dd6fd0: 0x0<br>0x7ffff7dd6fd8: 0x7ffff7dd7030 <g_static_so_data><br>0x7ffff7dd6fe0: 0x7ffff7dd7048 <g_static_so_bss><br>0x7ffff7dd6fe8: 0x0<br>0x7ffff7dd6ff0: 0x0<br>0x7ffff7dd6ff8: 0x0</g_static_so_bss></g_static_so_data></g_static_lib_bss></g_static_lib_data></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">对应0x7FFFF7DD6FE0的位置已经保存了正确的g_static_so_bss的地址.  </span><br><span class="line">再进一步读取变量的值:</span><br></pre></td></tr></table></figure>
<p>0x7ffff7dd7048 <g_static_so_bss>:       0xf4240  (1000000)<br>0x7ffff7dd7030 <g_static_so_data>:      0x186a0   (100000)  </g_static_so_data></g_static_so_bss></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">值也正确.   </span><br><span class="line">全局变量实际保存的位置对应so.so的可读写数据段   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### ..4.3.3. 全局函数访问代码分析</span><br></pre></td></tr></table></figure>
<p>int so_func(int a, int b)<br>{<br>  g_static_so_bss ++;<br>  g_static_so_data ++;<br>  int ret = lib_func(g_static_so_bss, g_static_so_data);<br>  ret += so_child_func(g_static_lib_data, g_static_lib_bss);<br>  ret += so_local_func();<br>  return ret;<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">对应的汇编码如下:  </span><br><span class="line">%esi保存了g_static_lib_data  %edi 保存了g_static_lib_bss   </span><br><span class="line">%rbx保存了base 偏移 8a3 + 0x20075d</span><br></pre></td></tr></table></figure>
<p> 934:   48 b8 00 f7 df ff ff    movabs $0xffffffffffdff700,%rax<br> 93b:   ff ff ff<br> 93e:   48 01 d8                add    %rbx,%rax<br> 941:   ff d0                   callq  *%rax</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这里callq的实际地址为 8a3 + 0x20075d -0x900 &#x3D; 0x200700   </span><br><span class="line">该地址位于.plt中  其偏移相对于.plt为:  0x200700-0x00000000000206e0 &#x3D; 0x20  偏移地址为700  </span><br><span class="line">我们找到代码位置</span><br></pre></td></tr></table></figure>

<p>00000000000006e0 &lt;.plt&gt;:<br> 6e0:   ff 35 22 09 20 00   pushq  0x200922(%rip)  # 201008 &lt;GOT_+0x8&gt; link_map<br> 6e6:   ff 25 24 09 20 00   jmpq   *0x200924(%rip) # 201010 &lt;GOT+0x10&gt; _dl_runtime_resolve_xsavec<br> 6ec:   0f 1f 40 00             nopl   0x0(%rax)</p>
<p>00000000000006f0 &lt;_Z13so_child_funcii@plt&gt;:<br> 6f0:   ff 25 22 09 20 00       jmpq   *0x200922(%rip)        # 201018 &lt;_Z13so_child_funcii@@Base+0x2007f8&gt;<br> 6f6:   68 00 00 00 00          pushq  $0x0<br> 6fb:   e9 e0 ff ff ff          jmpq   6e0 &lt;.plt&gt;</p>
<p>0000000000000700 &lt;_Z8lib_funcii@plt&gt;:<br> 700:   ff 25 1a 09 20 00       jmpq   *0x20091a(%rip)        # 201020 &lt;_Z8lib_funcii&gt;<br> 706:   68 01 00 00 00          pushq  $0x1<br> 70b:   e9 d0 ff ff ff          jmpq   6e0 &lt;.plt&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">700跳转到 (706+0x20091a) 这个地址保存的内存   </span><br><span class="line">这个地址为  0x201020  即.got.plt的第5项</span><br><span class="line">在elf文件中.got.plt是有5个值的, 第五项保存的值为706  也就是jmpq的下一行代码   </span><br><span class="line">&#96;&#96;&#96;pushq $0x1&#96;&#96;&#96;   意思是把当前的plt序号(.rela.plt的项)保存到栈上(传参)  </span><br><span class="line">在装载后, 相对偏移706会被替换成实际分配好的地址   </span><br><span class="line">因此第一次jmpq会跳转到偏移6e0处  </span><br><span class="line">再把got+8的位置压栈, (这个指针是link_map 后文会继续讲)   </span><br><span class="line">然后跳转到函数  &#96;&#96;&#96;_dl_runtime_resolve_xsavec&#96;&#96;&#96;   </span><br><span class="line"></span><br><span class="line">got+8 和got+10 将会完成符号的解析工作并找到真正的目标函数地址, 然后回写plt 执行目标函数.   </span><br><span class="line">这两项程序装载时会完成填充, 而后续的plt的其他函数会基于该机制以惰性加载机制调用时解析.  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GDB调试内容如下:</span><br></pre></td></tr></table></figure>
<p>0x7ffff7bd6700 &lt;_Z8lib_funcii@plt&gt;              jmpq   *0x20091a(%rip)        # 0x7ffff7dd7020<br>0x7ffff7bd6706 &lt;_Z8lib_funcii@plt+6&gt;            pushq  $0x1<br>0x7ffff7bd670b &lt;_Z8lib_funcii@plt+11&gt;           jmpq   0x7ffff7bd66e0<br>0x7ffff7bd6710                                  jmpq   *0x2008a2(%rip)        # 0x7ffff7dd6fb8  </p>
<p>(gdb) x /1ag 0x7ffff7dd7020<br>0x7ffff7dd7020: 0x7ffff7bd6706 &lt;_Z8lib_funcii@plt+6&gt;  </p>
<p>(gdb) x /5ag 0x7ffff7dd7000<br>0x7ffff7dd7000: 0x200dc8<br>0x7ffff7dd7008: 0x7ffff7ff6000<br>0x7ffff7dd7010: 0x7ffff7ded310 &lt;_dl_runtime_resolve_xsavec&gt;<br>0x7ffff7dd7018: 0x7ffff7bd66f6 &lt;_Z13so_child_funcii@plt+6&gt;<br>0x7ffff7dd7020: 0x7ffff7bd6706 &lt;_Z8lib_funcii@plt+6&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;_dl_runtime_resolve_xsavec&#96;&#96;&#96;  </span><br><span class="line">rbx+8为符号表链表指针   </span><br><span class="line">rbx+16为压到栈上的目标函数编号 存储在plt的下标从第四项开始, 前三项分别是offset, link_map, 解析函数  </span><br><span class="line">&#96;&#96;&#96;_dl_fixup&#96;&#96;&#96; 返回了查找到的真实地址 &#96;&#96;&#96;bnd jmpq *%r11&#96;&#96;&#96;  跳转到实际地址  </span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96; </span><br><span class="line">0x7ffff7ded310   push   %rbx                                                                </span><br><span class="line">0x7ffff7ded311   mov    %rsp,%rbx                                                           </span><br><span class="line">0x7ffff7ded314   and    $0xffffffffffffffc0,%rsp                                            </span><br><span class="line">0x7ffff7ded318   sub    0x20f4e9(%rip),%rsp        # 0x7ffff7ffc808 &lt;_rtld_global_ro+168&gt;   </span><br><span class="line">0x7ffff7ded31f   mov    %rax,(%rsp)                                                         </span><br><span class="line">0x7ffff7ded323   mov    %rcx,0x8(%rsp)                                                      </span><br><span class="line">0x7ffff7ded328   mov    %rdx,0x10(%rsp)                                                     </span><br><span class="line">0x7ffff7ded32d   mov    %rsi,0x18(%rsp)                                                     </span><br><span class="line">0x7ffff7ded332   mov    %rdi,0x20(%rsp)                                                     </span><br><span class="line">0x7ffff7ded337   mov    %r8,0x28(%rsp)                                                      </span><br><span class="line">0x7ffff7ded33c   mov    %r9,0x30(%rsp)                                                      </span><br><span class="line">0x7ffff7ded341   mov    $0xee,%eax                                                          </span><br><span class="line">0x7ffff7ded346   xor    %edx,%edx                                                           </span><br><span class="line">0x7ffff7ded348   mov    %rdx,0x250(%rsp)           </span><br><span class="line">0x7ffff7ded350   mov    %rdx,0x258(%rsp)           </span><br><span class="line">0x7ffff7ded358   mov    %rdx,0x260(%rsp)           </span><br><span class="line">0x7ffff7ded360   mov    %rdx,0x268(%rsp)           </span><br><span class="line">0x7ffff7ded368   mov    %rdx,0x270(%rsp)           </span><br><span class="line">0x7ffff7ded370   mov    %rdx,0x278(%rsp)           </span><br><span class="line">0x7ffff7ded378   xsavec 0x40(%rsp)                 </span><br><span class="line">0x7ffff7ded37d   mov    0x10(%rbx),%rsi            </span><br><span class="line">0x7ffff7ded381   mov    0x8(%rbx),%rdi             </span><br><span class="line">0x7ffff7ded385   callq  0x7ffff7de6630 &lt;_dl_fixup&gt; </span><br><span class="line">0x7ffff7ded38a   mov    %rax,%r11                  </span><br><span class="line">0x7ffff7ded38d   mov    $0xee,%eax                 </span><br><span class="line">0x7ffff7ded392   xor    %edx,%edx                  </span><br><span class="line">0x7ffff7ded394   xrstor 0x40(%rsp)         </span><br><span class="line">0x7ffff7ded399   mov    0x30(%rsp),%r9     </span><br><span class="line">0x7ffff7ded39e   mov    0x28(%rsp),%r8     </span><br><span class="line">0x7ffff7ded3a3   mov    0x20(%rsp),%rdi    </span><br><span class="line">0x7ffff7ded3a8   mov    0x18(%rsp),%rsi    </span><br><span class="line">0x7ffff7ded3ad   mov    0x10(%rsp),%rdx    </span><br><span class="line">0x7ffff7ded3b2   mov    0x8(%rsp),%rcx     </span><br><span class="line">0x7ffff7ded3b7   mov    (%rsp),%rax        </span><br><span class="line">0x7ffff7ded3bb   mov    %rbx,%rsp          </span><br><span class="line">0x7ffff7ded3be   mov    (%rsp),%rbx        </span><br><span class="line">0x7ffff7ded3c2   add    $0x18,%rsp         </span><br><span class="line">0x7ffff7ded3c6   bnd jmpq *%r11</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;C++</span><br><span class="line">&#x2F;&#x2F; Elf64_Rela</span><br><span class="line">typedef uint64_t Elf64_Addr;</span><br><span class="line">typedef uint64_t Elf64_Xword;</span><br><span class="line">typedef int64_t  Elf64_Sxword;</span><br><span class="line"> </span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf64_Addr        r_offset;                &#x2F;* Address *&#x2F;</span><br><span class="line">  Elf64_Xword        r_info;                 &#x2F;* Relocation type and symbol index *&#x2F;</span><br><span class="line">  Elf64_Sxword        r_addend;              &#x2F;* Addend *&#x2F;</span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/Elf64_Sym</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint32_t</span> Elf64_Word;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint16_t</span> Elf64_Section;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint64_t</span> Elf64_Addr;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint64_t</span> Elf64_Xword;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word        st_name;                <span class="comment">/* Symbol name (string tbl index), 4 bytes */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span>        st_info;             <span class="comment">/* Symbol type and binding, 1 byte */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> st_other;                   <span class="comment">/* Symbol visibility, 1 byte */</span></span><br><span class="line">  Elf64_Section        st_shndx;            <span class="comment">/* Section index, 2 bytes */</span></span><br><span class="line">  Elf64_Addr        st_value;               <span class="comment">/* Symbol value, 8 bytes */</span></span><br><span class="line">  Elf64_Xword        st_size;               <span class="comment">/* Symbol size, 8 bytes */</span></span><br><span class="line">&#125; Elf64_Sym;</span><br></pre></td></tr></table></figure>
<p>libc/elf/dl-runtime.c  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">__attribute ((noinline)) ARCH_FIXUP_ATTRIBUTE _dl_fixup (</span><br><span class="line">   <span class="comment">/* GKM <span class="doctag">FIXME:</span> Fix trampoline to pass bounds so we can do</span></span><br><span class="line"><span class="comment">      without the `__unbounded' qualifier.  */</span></span><br><span class="line">     struct link_map *__unbounded l, ElfW(Word) reloc_offset)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *<span class="keyword">const</span> symtab</span></span><br><span class="line"><span class="function">    </span>= (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *strtab = (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc</span><br><span class="line">    = (<span class="keyword">const</span> <span class="keyword">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">  <span class="keyword">void</span> *<span class="keyword">const</span> rel_addr = (<span class="keyword">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">  <span class="keyword">lookup_t</span> result;</span><br><span class="line">  DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Sanity check that we're really looking at a PLT relocation.  */</span></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">      used don't look in the global scope.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Half)</span> *vernum </span>=</span><br><span class="line">          (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">        ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">        version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">        <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">          version = <span class="literal">NULL</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment">       not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment">       we are not using any threads (yet).  */</span></span><br><span class="line">      <span class="keyword">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">      &#123;</span><br><span class="line">        THREAD_GSCOPE_SET_FLAG ();</span><br><span class="line">        flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">                            version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">      THREAD_GSCOPE_RESET_FLAG ();</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment">       of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment">       offset.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (result,</span><br><span class="line">                           sym ? (LOOKUP_VALUE_ADDRESS (result)</span><br><span class="line">                                + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment">       address) is also known.  */</span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);</span><br><span class="line">      result = l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* And now perhaps the relocation addend.  */</span></span><br><span class="line">  value = elf_machine_plt_value (l, reloc, value);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Finally, fix up the plt itself.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (GLRO(dl_bind_not), <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> elf_machine_fixup_plt (l, result, reloc, rel_addr, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>elf/dl-lookup.c  </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Search loaded objects' symbol tables for a definition of the symbol</span></span><br><span class="line"><span class="comment">   UNDEF_NAME, perhaps with a requested version for the symbol.</span></span><br><span class="line"><span class="comment">   We must never have calls to the audit functions inside this function</span></span><br><span class="line"><span class="comment">   or in any function which gets called.  If this would happen the audit</span></span><br><span class="line"><span class="comment">   code might create a thread which can throw off all the scope locking.  */</span></span><br><span class="line"><span class="keyword">lookup_t</span></span><br><span class="line">_dl_lookup_symbol_x (<span class="keyword">const</span> <span class="keyword">char</span> *undef_name, struct link_map *undef_map,</span><br><span class="line">                     <span class="keyword">const</span> ElfW(Sym) **ref,</span><br><span class="line">                     struct r_scope_elem *symbol_scope[],</span><br><span class="line">                     <span class="keyword">const</span> struct r_found_version *version,</span><br><span class="line">                     <span class="keyword">int</span> type_class, <span class="keyword">int</span> flags, struct link_map *skip_map);</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><figcaption><span>字符串表strtab   </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">reloc_offset即是传入的参数reloc_arg 其代表在.rela.plt表中的第几项 保存在reloc中   </span><br><span class="line">reloc的r_offset表示需要修改的函数地址在GOT表中的地址 加上装载地址l_addr得到的rel_addr就是最终要修改的.got.plt保存该函数地址的项的绝对地址  </span><br><span class="line"></span><br><span class="line">st_other描述符号的可见性 如果包含STV_PROTECTED、STV_HIDDEN和STV_INTERNAL的其中任何一种 则直接将装载地址加上st_value即得到函数的最终地址value 将其写入rel_addr    (相当于作用域不超过当前符号表的范围)  </span><br><span class="line"></span><br><span class="line">其他情况 会进入if语句   </span><br><span class="line">首先获得符号的version信息 然后调用 &#96;&#96;&#96;_dl_lookup_symbol_x&#96;&#96;&#96; 函数从已装载的共享库中查找最终的符号地址 查找到符号sym后 对其进行重定位 即加上装载地址 保存在value中      </span><br><span class="line">最后调用&#96;&#96;&#96;elf_machine_fixup_plt&#96;&#96;&#96;函数进行修正    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fixup plt  回写.got.plt的项</span><br></pre></td></tr></table></figure>
<p>static inline Elf64_Addr<br>elf_machine_fixup_plt (struct link_map *map, lookup_t t,<br>               const Elf64_Rela *reloc,<br>               Elf64_Addr *reloc_addr, Elf64_Addr value)<br>{<br>  return *reloc_addr = value;<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;_dl_lookup_symbol_x&#96;&#96;&#96;   </span><br><span class="line">...   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">got表和plt表在代码中是直接根据代码行的偏移获取的, 因此这里并无随机化过程   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">##### .got节内容  </span><br><span class="line">未填充任何数据</span><br></pre></td></tr></table></figure>
<p>zsummer@debian:~/symbo$ xxd -s+0x00000fb8 -l0x0000000000000048  so.so<br>00000fb8: 0000 0000 0000 0000 0000 0000 0000 0000  …………….<br>00000fc8: 0000 0000 0000 0000 0000 0000 0000 0000  …………….<br>00000fd8: 0000 0000 0000 0000 0000 0000 0000 0000  …………….<br>00000fe8: 0000 0000 0000 0000 0000 0000 0000 0000  …………….<br>00000ff8: 0000 0000 0000 0000                      ……..</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">##### .got.plt节  </span><br><span class="line">0x200dc8  </span><br><span class="line">0x0  </span><br><span class="line">0x0  </span><br><span class="line">0x6f6  </span><br><span class="line">0x706</span><br></pre></td></tr></table></figure>
<p>zsummer@debian:~/symbo$ xxd -s+0x00001000 -l0x0000000000000028  so.so<br>00001000: c80d 2000 0000 0000 0000 0000 0000 0000  .. ………….<br>00001010: 0000 0000 0000 0000 f606 0000 0000 0000  …………….<br>00001020: 0607 0000 0000 0000                      ……..</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### .data节  </span><br><span class="line">2101288  </span><br><span class="line">100000  </span><br><span class="line">0xff00ff00</span><br></pre></td></tr></table></figure>
<p>zsummer@debian:~/symbo$ xxd -s+0x00001028 -l0x0000000000000018  so.so<br>00001028: 2810 2000 0000 0000 a086 0100 0000 0000  (. ………….<br>00001038: 00ff 00ff 0000 0000                      ……..</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### pmap信息</span><br></pre></td></tr></table></figure>
<p>zsummer@debian:~/symbo$ pmap 9208<br>9208:   /home/zsummer/symbo/a.out<br>0000555555554000      4K r-x– a.out<br>0000555555754000      4K r—- a.out<br>0000555555755000    516K rw— a.out<br>00005555557d6000    132K rw—   [ anon ]<br>00007ffff6ef0000   1732K r-x– libc-2.27.so<br>00007ffff70a1000   2044K —– libc-2.27.so<br>00007ffff72a0000     16K r—- libc-2.27.so<br>00007ffff72a4000      8K rw— libc-2.27.so<br>00007ffff72a6000     16K rw—   [ anon ]<br>00007ffff72aa000     92K r-x– libgcc_s.so.1<br>00007ffff72c1000   2044K —– libgcc_s.so.1<br>00007ffff74c0000      4K r—- libgcc_s.so.1<br>00007ffff74c1000      4K rw— libgcc_s.so.1<br>00007ffff74c2000   1608K r-x– libm-2.27.so<br>00007ffff7654000   2044K —– libm-2.27.so<br>00007ffff7853000      4K r—- libm-2.27.so<br>00007ffff7854000      4K rw— libm-2.27.so<br>00007ffff7855000   1480K r-x– libstdc++.so.6.0.25<br>00007ffff79c7000   2048K —– libstdc++.so.6.0.25<br>00007ffff7bc7000     40K r—- libstdc++.so.6.0.25<br>00007ffff7bd1000      8K rw— libstdc++.so.6.0.25<br>00007ffff7bd3000     12K rw—   [ anon ]<br>00007ffff7bd6000      4K r-x– so.so<br>00007ffff7bd7000   2044K —– so.so<br>00007ffff7dd6000      4K r—- so.so<br>00007ffff7dd7000      4K rw— so.so<br>00007ffff7dd8000    148K r-x– ld-2.27.so<br>00007ffff7fd6000     20K rw—   [ anon ]<br>00007ffff7ff6000      8K rw—   [ anon ]<br>00007ffff7ff8000      8K r—-   [ anon ]<br>00007ffff7ffa000      8K r-x–   [ anon ]<br>00007ffff7ffc000      4K r—- ld-2.27.so<br>00007ffff7ffd000      4K rw— ld-2.27.so<br>00007ffff7ffe000      4K rw—   [ anon ]<br>00007ffffffde000    132K rw—   [ stack ]<br>ffffffffff600000      4K r-x–   [ anon ]<br> total            16260K</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">##### 节信息</span><br></pre></td></tr></table></figure>
<p>ELF 头：<br>  Magic：  7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00<br>  类别:                              ELF64<br>  数据:                              2 补码，小端序 (little endian)<br>  版本:                              1 (current)<br>  OS/ABI:                            UNIX - System V<br>  ABI 版本:                          0<br>  类型:                              DYN (共享目标文件)<br>  系统架构:                          Advanced Micro Devices X86-64<br>  版本:                              0x1<br>  入口点地址：              0x720<br>  程序头起点：              64 (bytes into file)<br>  Start of section headers:          6544 (bytes into file)<br>  标志：             0x0<br>  本头的大小：       64 (字节)<br>  程序头大小：       56 (字节)<br>  Number of program headers:         7<br>  节头大小：         64 (字节)<br>  节头数量：         28<br>  字符串表索引节头： 27</p>
<p>节头：<br>  [号] 名称              类型             地址              偏移量<br>       大小              全体大小          旗标   链接   信息   对齐<br>  [ 0]                   NULL             0000000000000000  00000000<br>       0000000000000000  0000000000000000           0     0     0<br>  [ 1] .note.gnu.build-i NOTE             00000000000001c8  000001c8<br>       0000000000000024  0000000000000000   A       0     0     4<br>  [ 2] .gnu.hash         GNU_HASH         00000000000001f0  000001f0<br>       0000000000000048  0000000000000000   A       3     0     8<br>  [ 3] .dynsym           DYNSYM           0000000000000238  00000238<br>       00000000000001b0  0000000000000018   A       4     1     8<br>  [ 4] .dynstr           STRTAB           00000000000003e8  000003e8<br>       000000000000013d  0000000000000000   A       0     0     1<br>  [ 5] .gnu.version      VERSYM           0000000000000526  00000526<br>       0000000000000024  0000000000000002   A       3     0     2<br>  [ 6] .gnu.version_r    VERNEED          0000000000000550  00000550<br>       0000000000000020  0000000000000000   A       4     1     8<br>  [ 7] .rela.dyn         RELA             0000000000000570  00000570<br>       0000000000000120  0000000000000018   A       3     0     8<br>  [ 8] .rela.plt         RELA             0000000000000690  00000690<br>       0000000000000030  0000000000000018  AI       3    21     8<br>  [ 9] .init             PROGBITS         00000000000006c0  000006c0<br>       0000000000000017  0000000000000000  AX       0     0     4<br>  [10] .plt              PROGBITS         00000000000006e0  000006e0<br>       0000000000000030  0000000000000010  AX       0     0     16<br>  [11] .plt.got          PROGBITS         0000000000000710  00000710<br>       0000000000000008  0000000000000000  AX       0     0     8<br>  [12] .text             PROGBITS         0000000000000720  00000720<br>       0000000000000282  0000000000000000  AX       0     0     16<br>  [13] .fini             PROGBITS         00000000000009a4  000009a4<br>       0000000000000009  0000000000000000  AX       0     0     4<br>  [14] .eh_frame_hdr     PROGBITS         00000000000009b0  000009b0<br>       0000000000000034  0000000000000000   A       0     0     4<br>  [15] .eh_frame         PROGBITS         00000000000009e8  000009e8<br>       00000000000000c4  0000000000000000   A       0     0     8<br>  [16] .init_array       INIT_ARRAY       0000000000200db0  00000db0<br>       0000000000000008  0000000000000008  WA       0     0     8<br>  [17] .fini_array       FINI_ARRAY       0000000000200db8  00000db8<br>       0000000000000008  0000000000000008  WA       0     0     8<br>  [18] .jcr              PROGBITS         0000000000200dc0  00000dc0<br>       0000000000000008  0000000000000000  WA       0     0     8<br>  [19] .dynamic          DYNAMIC          0000000000200dc8  00000dc8<br>       00000000000001f0  0000000000000010  WA       4     0     8<br>  [20] .got              PROGBITS         0000000000200fb8  00000fb8<br>       0000000000000048  0000000000000008  WA       0     0     8<br>  [21] .got.plt          PROGBITS         0000000000201000  00001000<br>       0000000000000028  0000000000000008  WA       0     0     8<br>  [22] .data             PROGBITS         0000000000201028  00001028<br>       0000000000000018  0000000000000000  WA       0     0     8<br>  [23] .bss              NOBITS           0000000000201040  00001040<br>       0000000000000010  0000000000000000  WA       0     0     8<br>  [24] .comment          PROGBITS         0000000000000000  00001040<br>       000000000000002d  0000000000000001  MS       0     0     1<br>  [25] .symtab           SYMTAB           0000000000000000  00001070<br>       00000000000005e8  0000000000000018          26    46     8<br>  [26] .strtab           STRTAB           0000000000000000  00001658<br>       0000000000000246  0000000000000000           0     0     1<br>  [27] .shstrtab         STRTAB           0000000000000000  0000189e<br>       00000000000000ee  0000000000000000           0     0     1<br>Key to Flags:<br>  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),<br>  L (link order), O (extra OS processing required), G (group), T (TLS),<br>  C (compressed), x (unknown), o (OS specific), E (exclude),<br>  l (large), p (processor specific)</p>
<p>There are no section groups in this file.</p>
<p>程序头：<br>  Type           Offset             VirtAddr           PhysAddr<br>                 FileSiz            MemSiz              Flags  Align<br>  LOAD           0x0000000000000000 0x0000000000000000 0x0000000000000000<br>                 0x0000000000000aac 0x0000000000000aac  R E    0x200000<br>  LOAD           0x0000000000000db0 0x0000000000200db0 0x0000000000200db0<br>                 0x0000000000000290 0x00000000000002a0  RW     0x200000<br>  DYNAMIC        0x0000000000000dc8 0x0000000000200dc8 0x0000000000200dc8<br>                 0x00000000000001f0 0x00000000000001f0  RW     0x8<br>  NOTE           0x00000000000001c8 0x00000000000001c8 0x00000000000001c8<br>                 0x0000000000000024 0x0000000000000024  R      0x4<br>  GNU_EH_FRAME   0x00000000000009b0 0x00000000000009b0 0x00000000000009b0<br>                 0x0000000000000034 0x0000000000000034  R      0x4<br>  GNU_STACK      0x0000000000000000 0x0000000000000000 0x0000000000000000<br>                 0x0000000000000000 0x0000000000000000  RW     0x10<br>  GNU_RELRO      0x0000000000000db0 0x0000000000200db0 0x0000000000200db0<br>                 0x0000000000000250 0x0000000000000250  R      0x1</p>
<p> Section to Segment mapping:<br>  段节…<br>   00     .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .plt.got .text .fini .eh_frame_hdr .eh_frame<br>   01     .init_array .fini_array .jcr .dynamic .got .got.plt .data .bss<br>   02     .dynamic<br>   03     .note.gnu.build-id<br>   04     .eh_frame_hdr<br>   05<br>   06     .init_array .fini_array .jcr .dynamic .got </p>
<p>Dynamic section at offset 0xdc8 contains 27 entries:<br>  标记        类型                         名称/值<br> 0x0000000000000001 (NEEDED)             共享库：[libstdc++.so.6]<br> 0x0000000000000001 (NEEDED)             共享库：[libm.so.6]<br> 0x0000000000000001 (NEEDED)             共享库：[libgcc_s.so.1]<br> 0x0000000000000001 (NEEDED)             共享库：[libc.so.6]<br> 0x000000000000000c (INIT)               0x6c0<br> 0x000000000000000d (FINI)               0x9a4<br> 0x0000000000000019 (INIT_ARRAY)         0x200db0<br> 0x000000000000001b (INIT_ARRAYSZ)       8 (bytes)<br> 0x000000000000001a (FINI_ARRAY)         0x200db8<br> 0x000000000000001c (FINI_ARRAYSZ)       8 (bytes)<br> 0x000000006ffffef5 (GNU_HASH)           0x1f0<br> 0x0000000000000005 (STRTAB)             0x3e8<br> 0x0000000000000006 (SYMTAB)             0x238<br> 0x000000000000000a (STRSZ)              317 (bytes)<br> 0x000000000000000b (SYMENT)             24 (bytes)<br> 0x0000000000000003 (PLTGOT)             0x201000<br> 0x0000000000000002 (PLTRELSZ)           48 (bytes)<br> 0x0000000000000014 (PLTREL)             RELA<br> 0x0000000000000017 (JMPREL)             0x690<br> 0x0000000000000007 (RELA)               0x570<br> 0x0000000000000008 (RELASZ)             288 (bytes)<br> 0x0000000000000009 (RELAENT)            24 (bytes)<br> 0x000000006ffffffe (VERNEED)            0x550<br> 0x000000006fffffff (VERNEEDNUM)         1<br> 0x000000006ffffff0 (VERSYM)             0x526<br> 0x000000006ffffff9 (RELACOUNT)          3<br> 0x0000000000000000 (NULL)               0x0</p>
<p>重定位节 ‘.rela.dyn’ 位于偏移量 0x570 含有 12 个条目：<br>  偏移量          信息           类型           符号值        符号名称 + 加数<br>000000200db0  000000000008 R_X86_64_RELATIVE                    7f0<br>000000200db8  000000000008 R_X86_64_RELATIVE                    7b0<br>000000201028  000000000008 R_X86_64_RELATIVE                    201028<br>000000200fb8  000100000006 R_X86_64_GLOB_DAT 0000000000000000 <strong><a href="mailto:cxa_finalize@GLIBC_2.2.5">cxa_finalize@GLIBC_2.2.5</a> + 0<br>000000200fc0  000200000006 R_X86_64_GLOB_DAT 0000000000000000 g_static_lib_data + 0<br>000000200fc8  000300000006 R_X86_64_GLOB_DAT 0000000000000000 g_static_lib_bss + 0<br>000000200fd0  000400000006 R_X86_64_GLOB_DAT 0000000000000000 _Jv_RegisterClasses + 0<br>000000200fd8  001100000006 R_X86_64_GLOB_DAT 0000000000201030 g_static_so_data + 0<br>000000200fe0  000d00000006 R_X86_64_GLOB_DAT 0000000000201048 g_static_so_bss + 0<br>000000200fe8  000500000006 R_X86_64_GLOB_DAT 0000000000000000 _ITM_deregisterTMClone + 0<br>000000200ff0  000700000006 R_X86_64_GLOB_DAT 0000000000000000 __gmon_start</strong> + 0<br>000000200ff8  000800000006 R_X86_64_GLOB_DAT 0000000000000000 _ITM_registerTMCloneTa + 0</p>
<p>重定位节 ‘.rela.plt’ 位于偏移量 0x690 含有 2 个条目：<br>  偏移量          信息           类型           符号值        符号名称 + 加数<br>000000201018  001000000007 R_X86_64_JUMP_SLO 0000000000000820 _Z13so_child_funcii + 0<br>000000201020  000600000007 R_X86_64_JUMP_SLO 0000000000000000 _Z8lib_funcii + 0</p>
<p>The decoding of unwind sections for machine type Advanced Micro Devices X86-64 is not currently supported.</p>
<p>Symbol table ‘.dynsym’ contains 18 entries:<br>   Num:    Value          Size Type    Bind   Vis      Ndx Name<br>     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND<br>     1: 0000000000000000     0 FUNC    WEAK   DEFAULT  UND <strong><a href="mailto:cxa_finalize@GLIBC_2.2.5">cxa_finalize@GLIBC_2.2.5</a> (2)<br>     2: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND g_static_lib_data<br>     3: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND g_static_lib_bss<br>     4: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses<br>     5: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab<br>     6: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _Z8lib_funcii<br>     7: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start</strong><br>     8: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable<br>     9: 0000000000201040     0 NOTYPE  GLOBAL DEFAULT   22 _edata<br>    10: 0000000000201050     0 NOTYPE  GLOBAL DEFAULT   23 _end<br>    11: 00000000000006c0     0 FUNC    GLOBAL DEFAULT    9 _init<br>    12: 0000000000201040     0 NOTYPE  GLOBAL DEFAULT   23 __bss_start<br>    13: 0000000000201048     8 OBJECT  GLOBAL DEFAULT   23 g_static_so_bss<br>    14: 0000000000000898   266 FUNC    GLOBAL DEFAULT   12 _Z7so_funcii<br>    15: 00000000000009a4     0 FUNC    GLOBAL DEFAULT   13 _fini<br>    16: 0000000000000820    80 FUNC    GLOBAL DEFAULT   12 _Z13so_child_funcii<br>    17: 0000000000201030     8 OBJECT  GLOBAL DEFAULT   22 g_static_so_data</p>
<p>Symbol table ‘.symtab’ contains 63 entries:<br>   Num:    Value          Size Type    Bind   Vis      Ndx Name<br>     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND<br>     1: 00000000000001c8     0 SECTION LOCAL  DEFAULT    1<br>     2: 00000000000001f0     0 SECTION LOCAL  DEFAULT    2<br>     3: 0000000000000238     0 SECTION LOCAL  DEFAULT    3<br>     4: 00000000000003e8     0 SECTION LOCAL  DEFAULT    4<br>     5: 0000000000000526     0 SECTION LOCAL  DEFAULT    5<br>     6: 0000000000000550     0 SECTION LOCAL  DEFAULT    6<br>     7: 0000000000000570     0 SECTION LOCAL  DEFAULT    7<br>     8: 0000000000000690     0 SECTION LOCAL  DEFAULT    8<br>     9: 00000000000006c0     0 SECTION LOCAL  DEFAULT    9<br>    10: 00000000000006e0     0 SECTION LOCAL  DEFAULT   10<br>    11: 0000000000000710     0 SECTION LOCAL  DEFAULT   11<br>    12: 0000000000000720     0 SECTION LOCAL  DEFAULT   12<br>    13: 00000000000009a4     0 SECTION LOCAL  DEFAULT   13<br>    14: 00000000000009b0     0 SECTION LOCAL  DEFAULT   14<br>    15: 00000000000009e8     0 SECTION LOCAL  DEFAULT   15<br>    16: 0000000000200db0     0 SECTION LOCAL  DEFAULT   16<br>    17: 0000000000200db8     0 SECTION LOCAL  DEFAULT   17<br>    18: 0000000000200dc0     0 SECTION LOCAL  DEFAULT   18<br>    19: 0000000000200dc8     0 SECTION LOCAL  DEFAULT   19<br>    20: 0000000000200fb8     0 SECTION LOCAL  DEFAULT   20<br>    21: 0000000000201000     0 SECTION LOCAL  DEFAULT   21<br>    22: 0000000000201028     0 SECTION LOCAL  DEFAULT   22<br>    23: 0000000000201040     0 SECTION LOCAL  DEFAULT   23<br>    24: 0000000000000000     0 SECTION LOCAL  DEFAULT   24<br>    25: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c<br>    26: 0000000000200dc0     0 OBJECT  LOCAL  DEFAULT   18 <strong>JCR_LIST</strong><br>    27: 0000000000000720     0 FUNC    LOCAL  DEFAULT   12 deregister_tm_clones<br>    28: 0000000000000760     0 FUNC    LOCAL  DEFAULT   12 register_tm_clones<br>    29: 00000000000007b0     0 FUNC    LOCAL  DEFAULT   12 <strong>do_global_dtors_aux<br>    30: 0000000000201040     1 OBJECT  LOCAL  DEFAULT   23 completed.6972<br>    31: 0000000000200db8     0 OBJECT  LOCAL  DEFAULT   17 <em>_do_global_dtors_aux_fin<br>    32: 00000000000007f0     0 FUNC    LOCAL  DEFAULT   12 frame_dummy<br>    33: 0000000000200db0     0 OBJECT  LOCAL  DEFAULT   16 __frame_dummy_init_array</em><br>    34: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS so.cpp<br>    35: 0000000000201038     8 OBJECT  LOCAL  DEFAULT   22 _ZL15g_local_so_data<br>    36: 0000000000000870    40 FUNC    LOCAL  DEFAULT   12 _ZL13so_local_funcv<br>    37: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS crtstuff.c<br>    38: 0000000000000aa8     0 OBJECT  LOCAL  DEFAULT   15 __FRAME_END</strong><br>    39: 0000000000200dc0     0 OBJECT  LOCAL  DEFAULT   18 <strong>JCR_END</strong><br>    40: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS<br>    41: 00000000000009b0     0 NOTYPE  LOCAL  DEFAULT   14 <strong>GNU_EH_FRAME_HDR<br>    42: 0000000000201028     0 OBJECT  LOCAL  DEFAULT   22 __dso_handle<br>    43: 0000000000200dc8     0 OBJECT  LOCAL  DEFAULT   19 _DYNAMIC<br>    44: 0000000000201040     0 OBJECT  LOCAL  DEFAULT   22 __TMC_END</strong><br>    45: 0000000000201000     0 OBJECT  LOCAL  DEFAULT   21 <em>GLOBAL_OFFSET_TABLE</em><br>    46: 0000000000201040     0 NOTYPE  GLOBAL DEFAULT   22 <em>edata<br>    47: 0000000000000000     0 FUNC    WEAK   DEFAULT  UND <em>_cxa_finalize@@GLIBC_2.2<br>    48: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND g_static_lib_data<br>    49: 00000000000009a4     0 FUNC    GLOBAL DEFAULT   13 _fini<br>    50: 0000000000000820    80 FUNC    GLOBAL DEFAULT   12 _Z13so_child_funcii<br>    51: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND g_static_lib_bss<br>    52: 00000000000006c0     0 FUNC    GLOBAL DEFAULT    9 _init<br>    53: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses<br>    54: 0000000000201030     8 OBJECT  GLOBAL DEFAULT   22 g_static_so_data<br>    55: 0000000000201050     0 NOTYPE  GLOBAL DEFAULT   23 _end<br>    56: 0000000000201040     0 NOTYPE  GLOBAL DEFAULT   23 __bss_start<br>    57: 0000000000201048     8 OBJECT  GLOBAL DEFAULT   23 g_static_so_bss<br>    58: 0000000000000898   266 FUNC    GLOBAL DEFAULT   12 _Z7so_funcii<br>    59: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab<br>    60: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _Z8lib_funcii<br>    61: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start</em></em><br>    62: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</p>
<p>Histogram for `.gnu.hash’ bucket list length (total of 3 buckets):<br> Length  Number     % of total  Coverage<br>      0  0          (  0.0%)<br>      1  0          (  0.0%)      0.0%<br>      2  1          ( 33.3%)     22.2%<br>      3  1          ( 33.3%)     55.6%<br>      4  1          ( 33.3%)    100.0%</p>
<p>Version symbols section ‘.gnu.version’ contains 18 entries:<br> 地址：0000000000000526  Offset: 0x000526  Link: 3 (.dynsym)<br>  000:   0 (<em>本地</em>)       2 (GLIBC_2.2.5)   0 (<em>本地</em>)       0 (<em>本地</em>)<br>  004:   0 (<em>本地</em>)       0 (<em>本地</em>)       0 (<em>本地</em>)       0 (<em>本地</em>)<br>  008:   0 (<em>本地</em>)       1 (<em>全局</em>)      1 (<em>全局</em>)      1 (<em>全局</em>)<br>  00c:   1 (<em>全局</em>)      1 (<em>全局</em>)      1 (<em>全局</em>)      1 (<em>全局</em>)<br>  010:   1 (<em>全局</em>)      1 (<em>全局</em>)   </p>
<p>Version needs section ‘.gnu.version_r’ contains 1 entries:<br> 地址：0x0000000000000550  Offset: 0x000550  Link: 4 (.dynstr)<br>  000000: 版本: 1  文件：libc.so.6  计数：1<br>  0x0010：名称：GLIBC_2.2.5  标志：无  版本：2</p>
<p>Displaying notes found in: .note.gnu.build-id<br>  所有者             Data size  Description<br>  GNU                  0x00000014       NT_GNU_BUILD_ID (unique build ID bitstring)<br>    Build ID: 09ce242e3867431b496a7f5928e9817fa91d242a</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">##### 代码节</span><br></pre></td></tr></table></figure>
<p>so.so：     文件格式 elf64-x86-64</p>
<p>Disassembly of section .init:</p>
<p>00000000000006c0 &lt;<em>init&gt;:<br> 6c0:   48 83 ec 08             sub    $0x8,%rsp<br> 6c4:   48 8b 05 25 09 20 00    mov    0x200925(%rip),%rax        # 200ff0 &lt;<em>_gmon_start</em></em>&gt;<br> 6cb:   48 85 c0                test   %rax,%rax<br> 6ce:   74 02                   je     6d2 &lt;_init+0x12&gt;<br> 6d0:   ff d0                   callq  *%rax<br> 6d2:   48 83 c4 08             add    $0x8,%rsp<br> 6d6:   c3                      retq   </p>
<p>Disassembly of section .plt:</p>
<p>00000000000006e0 &lt;.plt&gt;:<br> 6e0:   ff 35 22 09 20 00       pushq  0x200922(%rip)        # 201008 &lt;<em>GLOBAL_OFFSET_TABLE</em>+0x8&gt;<br> 6e6:   ff 25 24 09 20 00       jmpq   *0x200924(%rip)        # 201010 &lt;<em>GLOBAL_OFFSET_TABLE</em>+0x10&gt;<br> 6ec:   0f 1f 40 00             nopl   0x0(%rax)</p>
<p>00000000000006f0 &lt;_Z13so_child_funcii@plt&gt;:<br> 6f0:   ff 25 22 09 20 00       jmpq   *0x200922(%rip)        # 201018 &lt;_Z13so_child_funcii@@Base+0x2007f8&gt;<br> 6f6:   68 00 00 00 00          pushq  $0x0<br> 6fb:   e9 e0 ff ff ff          jmpq   6e0 &lt;.plt&gt;</p>
<p>0000000000000700 &lt;_Z8lib_funcii@plt&gt;:<br> 700:   ff 25 1a 09 20 00       jmpq   *0x20091a(%rip)        # 201020 &lt;_Z8lib_funcii&gt;<br> 706:   68 01 00 00 00          pushq  $0x1<br> 70b:   e9 d0 ff ff ff          jmpq   6e0 &lt;.plt&gt;</p>
<p>Disassembly of section .plt.got:</p>
<p>0000000000000710 &lt;.plt.got&gt;:<br> 710:   ff 25 a2 08 20 00       jmpq   *0x2008a2(%rip)        # 200fb8 &lt;<a href="mailto:__cxa_finalize@GLIBC_2.2.5">__cxa_finalize@GLIBC_2.2.5</a>&gt;<br> 716:   66 90                   xchg   %ax,%ax</p>
<p>Disassembly of section .text:</p>
<p>0000000000000720 <deregister_tm_clones>:<br> 720:   48 8d 3d 19 09 20 00    lea    0x200919(%rip),%rdi        # 201040 &lt;_edata&gt;<br> 727:   48 8d 05 19 09 20 00    lea    0x200919(%rip),%rax        # 201047 &lt;_edata+0x7&gt;<br> 72e:   55                      push   %rbp<br> 72f:   48 29 f8                sub    %rdi,%rax<br> 732:   48 89 e5                mov    %rsp,%rbp<br> 735:   48 83 f8 0e             cmp    $0xe,%rax<br> 739:   76 15                   jbe    750 &lt;deregister_tm_clones+0x30&gt;<br> 73b:   48 8b 05 a6 08 20 00    mov    0x2008a6(%rip),%rax        # 200fe8 &lt;_ITM_deregisterTMCloneTable&gt;<br> 742:   48 85 c0                test   %rax,%rax<br> 745:   74 09                   je     750 &lt;deregister_tm_clones+0x30&gt;<br> 747:   5d                      pop    %rbp<br> 748:   ff e0                   jmpq   *%rax<br> 74a:   66 0f 1f 44 00 00       nopw   0x0(%rax,%rax,1)<br> 750:   5d                      pop    %rbp<br> 751:   c3                      retq<br> 752:   0f 1f 40 00             nopl   0x0(%rax)<br> 756:   66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)<br> 75d:   00 00 00 </deregister_tm_clones></p>
<p>0000000000000760 <register_tm_clones>:<br> 760:   48 8d 3d d9 08 20 00    lea    0x2008d9(%rip),%rdi        # 201040 &lt;_edata&gt;<br> 767:   48 8d 35 d2 08 20 00    lea    0x2008d2(%rip),%rsi        # 201040 &lt;_edata&gt;<br> 76e:   55                      push   %rbp<br> 76f:   48 29 fe                sub    %rdi,%rsi<br> 772:   48 89 e5                mov    %rsp,%rbp<br> 775:   48 c1 fe 03             sar    $0x3,%rsi<br> 779:   48 89 f0                mov    %rsi,%rax<br> 77c:   48 c1 e8 3f             shr    $0x3f,%rax<br> 780:   48 01 c6                add    %rax,%rsi<br> 783:   48 d1 fe                sar    %rsi<br> 786:   74 18                   je     7a0 &lt;register_tm_clones+0x40&gt;<br> 788:   48 8b 05 69 08 20 00    mov    0x200869(%rip),%rax        # 200ff8 &lt;_ITM_registerTMCloneTable&gt;<br> 78f:   48 85 c0                test   %rax,%rax<br> 792:   74 0c                   je     7a0 &lt;register_tm_clones+0x40&gt;<br> 794:   5d                      pop    %rbp<br> 795:   ff e0                   jmpq   *%rax<br> 797:   66 0f 1f 84 00 00 00    nopw   0x0(%rax,%rax,1)<br> 79e:   00 00<br> 7a0:   5d                      pop    %rbp<br> 7a1:   c3                      retq<br> 7a2:   0f 1f 40 00             nopl   0x0(%rax)<br> 7a6:   66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)<br> 7ad:   00 00 00 </register_tm_clones></p>
<p>00000000000007b0 &lt;<strong>do_global_dtors_aux&gt;:<br> 7b0:   80 3d 89 08 20 00 00    cmpb   $0x0,0x200889(%rip)        # 201040 &lt;_edata&gt;<br> 7b7:   75 27                   jne    7e0 &lt;</strong>do_global_dtors_aux+0x30&gt;<br> 7b9:   48 83 3d f7 07 20 00    cmpq   $0x0,0x2007f7(%rip)        # 200fb8 &lt;<strong><a href="mailto:cxa_finalize@GLIBC_2.2.5">cxa_finalize@GLIBC_2.2.5</a>&gt;<br> 7c0:   00<br> 7c1:   55                      push   %rbp<br> 7c2:   48 89 e5                mov    %rsp,%rbp<br> 7c5:   74 0c                   je     7d3 &lt;</strong>do_global_dtors_aux+0x23&gt;<br> 7c7:   48 8b 3d 5a 08 20 00    mov    0x20085a(%rip),%rdi        # 201028 &lt;__dso_handle&gt;<br> 7ce:   e8 3d ff ff ff          callq  710 &lt;.plt.got&gt;<br> 7d3:   e8 48 ff ff ff          callq  720 <deregister_tm_clones><br> 7d8:   5d                      pop    %rbp<br> 7d9:   c6 05 60 08 20 00 01    movb   $0x1,0x200860(%rip)        # 201040 &lt;_edata&gt;<br> 7e0:   f3 c3                   repz retq<br> 7e2:   0f 1f 40 00             nopl   0x0(%rax)<br> 7e6:   66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)<br> 7ed:   00 00 00 </deregister_tm_clones></p>
<p>00000000000007f0 <frame_dummy>:<br> 7f0:   48 8d 3d c9 05 20 00    lea    0x2005c9(%rip),%rdi        # 200dc0 &lt;<strong>JCR_END</strong>&gt;<br> 7f7:   48 83 3f 00             cmpq   $0x0,(%rdi)<br> 7fb:   75 0b                   jne    808 &lt;frame_dummy+0x18&gt;<br> 7fd:   e9 5e ff ff ff          jmpq   760 <register_tm_clones><br> 802:   66 0f 1f 44 00 00       nopw   0x0(%rax,%rax,1)<br> 808:   48 8b 05 c1 07 20 00    mov    0x2007c1(%rip),%rax        # 200fd0 &lt;_Jv_RegisterClasses&gt;<br> 80f:   48 85 c0                test   %rax,%rax<br> 812:   74 e9                   je     7fd &lt;frame_dummy+0xd&gt;<br> 814:   55                      push   %rbp<br> 815:   48 89 e5                mov    %rsp,%rbp<br> 818:   ff d0                   callq  *%rax<br> 81a:   5d                      pop    %rbp<br> 81b:   e9 40 ff ff ff          jmpq   760 <register_tm_clones></register_tm_clones></register_tm_clones></frame_dummy></p>
<p>0000000000000820 &lt;_Z13so_child_funcii&gt;:<br> 820:   55                      push   %rbp<br> 821:   48 89 e5                mov    %rsp,%rbp<br> 824:   48 8d 05 f9 ff ff ff    lea    -0x7(%rip),%rax        # 824 &lt;_Z13so_child_funcii+0x4&gt;<br> 82b:   49 bb dc 07 20 00 00    movabs $0x2007dc,%r11<br> 832:   00 00 00<br> 835:   4c 01 d8                add    %r11,%rax<br> 838:   89 7d fc                mov    %edi,-0x4(%rbp)<br> 83b:   89 75 f8                mov    %esi,-0x8(%rbp)<br> 83e:   8b 4d fc                mov    -0x4(%rbp),%ecx<br> 841:   8b 55 f8                mov    -0x8(%rbp),%edx<br> 844:   01 ca                   add    %ecx,%edx<br> 846:   89 d1                   mov    %edx,%ecx<br> 848:   48 ba e0 ff ff ff ff    movabs $0xffffffffffffffe0,%rdx<br> 84f:   ff ff ff<br> 852:   48 8b 14 10             mov    (%rax,%rdx,1),%rdx<br> 856:   48 8b 12                mov    (%rdx),%rdx<br> 859:   01 d1                   add    %edx,%ecx<br> 85b:   48 ba d8 ff ff ff ff    movabs $0xffffffffffffffd8,%rdx<br> 862:   ff ff ff<br> 865:   48 8b 04 10             mov    (%rax,%rdx,1),%rax<br> 869:   48 8b 00                mov    (%rax),%rax<br> 86c:   01 c8                   add    %ecx,%eax<br> 86e:   5d                      pop    %rbp<br> 86f:   c3                      retq   </p>
<p>0000000000000870 &lt;_ZL13so_local_funcv&gt;:<br> 870:   55                      push   %rbp<br> 871:   48 89 e5                mov    %rsp,%rbp<br> 874:   48 8d 05 f9 ff ff ff    lea    -0x7(%rip),%rax        # 874 &lt;_ZL13so_local_funcv+0x4&gt;<br> 87b:   49 bb 8c 07 20 00 00    movabs $0x20078c,%r11<br> 882:   00 00 00<br> 885:   4c 01 d8                add    %r11,%rax<br> 888:   48 ba 38 00 00 00 00    movabs $0x38,%rdx<br> 88f:   00 00 00<br> 892:   48 8b 04 10             mov    (%rax,%rdx,1),%rax<br> 896:   5d                      pop    %rbp<br> 897:   c3                      retq   </p>
<p>0000000000000898 &lt;_Z7so_funcii&gt;:<br> 898:   55                      push   %rbp<br> 899:   48 89 e5                mov    %rsp,%rbp<br> 89c:   41 57                   push   %r15<br> 89e:   53                      push   %rbx<br> 89f:   48 83 ec 20             sub    $0x20,%rsp<br> 8a3:   48 8d 1d f9 ff ff ff    lea    -0x7(%rip),%rbx        # 8a3 &lt;_Z7so_funcii+0xb&gt;<br> 8aa:   49 bb 5d 07 20 00 00    movabs $0x20075d,%r11<br> 8b1:   00 00 00<br> 8b4:   4c 01 db                add    %r11,%rbx<br> 8b7:   89 7d dc                mov    %edi,-0x24(%rbp)<br> 8ba:   89 75 d8                mov    %esi,-0x28(%rbp)<br> 8bd:   48 b8 e0 ff ff ff ff    movabs $0xffffffffffffffe0,%rax<br> 8c4:   ff ff ff<br> 8c7:   48 8b 04 03             mov    (%rbx,%rax,1),%rax<br> 8cb:   48 8b 00                mov    (%rax),%rax<br> 8ce:   48 8d 50 01             lea    0x1(%rax),%rdx<br> 8d2:   48 b8 e0 ff ff ff ff    movabs $0xffffffffffffffe0,%rax<br> 8d9:   ff ff ff<br> 8dc:   48 8b 04 03             mov    (%rbx,%rax,1),%rax<br> 8e0:   48 89 10                mov    %rdx,(%rax)<br> 8e3:   48 b8 d8 ff ff ff ff    movabs $0xffffffffffffffd8,%rax<br> 8ea:   ff ff ff<br> 8ed:   48 8b 04 03             mov    (%rbx,%rax,1),%rax<br> 8f1:   48 8b 00                mov    (%rax),%rax<br> 8f4:   48 8d 50 01             lea    0x1(%rax),%rdx<br> 8f8:   48 b8 d8 ff ff ff ff    movabs $0xffffffffffffffd8,%rax<br> 8ff:   ff ff ff<br> 902:   48 8b 04 03             mov    (%rbx,%rax,1),%rax<br> 906:   48 89 10                mov    %rdx,(%rax)<br> 909:   48 b8 d8 ff ff ff ff    movabs $0xffffffffffffffd8,%rax<br> 910:   ff ff ff<br> 913:   48 8b 04 03             mov    (%rbx,%rax,1),%rax<br> 917:   48 8b 00                mov    (%rax),%rax<br> 91a:   89 c2                   mov    %eax,%edx<br> 91c:   48 b8 e0 ff ff ff ff    movabs $0xffffffffffffffe0,%rax<br> 923:   ff ff ff<br> 926:   48 8b 04 03             mov    (%rbx,%rax,1),%rax<br> 92a:   48 8b 00                mov    (%rax),%rax<br> 92d:   89 d6                   mov    %edx,%esi<br> 92f:   89 c7                   mov    %eax,%edi<br> 931:   49 89 df                mov    %rbx,%r15<br> 934:   48 b8 00 f7 df ff ff    movabs $0xffffffffffdff700,%rax<br> 93b:   ff ff ff<br> 93e:   48 01 d8                add    %rbx,%rax<br> 941:   ff d0                   callq  *%rax<br> 943:   89 45 ec                mov    %eax,-0x14(%rbp)<br> 946:   48 b8 c8 ff ff ff ff    movabs $0xffffffffffffffc8,%rax<br> 94d:   ff ff ff<br> 950:   48 8b 04 03             mov    (%rbx,%rax,1),%rax<br> 954:   48 8b 00                mov    (%rax),%rax<br> 957:   89 c2                   mov    %eax,%edx<br> 959:   48 b8 c0 ff ff ff ff    movabs $0xffffffffffffffc0,%rax<br> 960:   ff ff ff<br> 963:   48 8b 04 03             mov    (%rbx,%rax,1),%rax<br> 967:   48 8b 00                mov    (%rax),%rax<br> 96a:   89 d6                   mov    %edx,%esi<br> 96c:   89 c7                   mov    %eax,%edi<br> 96e:   49 89 df                mov    %rbx,%r15<br> 971:   48 b8 f0 f6 df ff ff    movabs $0xffffffffffdff6f0,%rax<br> 978:   ff ff ff<br> 97b:   48 01 d8                add    %rbx,%rax<br> 97e:   ff d0                   callq  *%rax<br> 980:   01 45 ec                add    %eax,-0x14(%rbp)<br> 983:   48 b8 70 f8 df ff ff    movabs $0xffffffffffdff870,%rax<br> 98a:   ff ff ff<br> 98d:   48 8d 04 03             lea    (%rbx,%rax,1),%rax<br> 991:   ff d0                   callq  *%rax<br> 993:   01 45 ec                add    %eax,-0x14(%rbp)<br> 996:   8b 45 ec                mov    -0x14(%rbp),%eax<br> 999:   48 83 c4 20             add    $0x20,%rsp<br> 99d:   5b                      pop    %rbx<br> 99e:   41 5f                   pop    %r15<br> 9a0:   5d                      pop    %rbp<br> 9a1:   c3                      retq   </p>
<p>Disassembly of section .fini:</p>
<p>00000000000009a4 &lt;_fini&gt;:<br> 9a4:   48 83 ec 08             sub    $0x8,%rsp<br> 9a8:   48 83 c4 08             add    $0x8,%rsp<br> 9ac:   c3                      retq   </p>
<pre><code>
### 动态库装载过程  
[linux kernel 源码](https://elixir.bootlin.com/linux/latest/source)  

#### ELF的辅助向量 AUXV   
main函数的第三个参数  char* envp[]    

LD_SHOW_AUXV=1 whoami 

#### load_elf_binary函数  
* 填充并且检查目标程序ELF头部
* load_elf_phdrs加载目标程序的程序头表
* 如果需要动态链接, 则寻找和处理解释器段
* 检查并读取解释器的程序表头
* 装入目标程序的段segment
* create_elf_tables填写目标文件的参数环境变量等必要信息
* start_kernel宏准备进入新的程序入口









&lt;/font&gt;</code></pre></font>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/11/2019-12-11-asm-syntax/" rel="next" title="汇编语法/寻址/寄存器/代码模型(GNU assembler)">
                <i class="fa fa-chevron-left"></i> 汇编语法/寻址/寄存器/代码模型(GNU assembler)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/17/2019-12-17-elf-load/" rel="prev" title="ELF装载和动态链接过程">
                ELF装载和动态链接过程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="夏天" />
          <p class="site-author-name" itemprop="name">夏天</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">40</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">1.</span> <span class="nav-text">..1. 目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">2.</span> <span class="nav-text">..2. 准备工具和基础汇编知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">3.</span> <span class="nav-text">..3. 编译链接过程的基本原理和流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">3.1.</span> <span class="nav-text">..3.1. gcc中编译一个源文件可以拆分为4个部分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">3.2.</span> <span class="nav-text">..3.2. 编译单元(Translation environment), 编译的转换阶段 :</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">3.3.</span> <span class="nav-text">..3.3. PIC PIE 位置无关代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">3.4.</span> <span class="nav-text">..3.4. GOT PLT 全局偏移表 链接过程表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">3.5.</span> <span class="nav-text">..3.5. 符号表和符号</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">3.5.1.</span> <span class="nav-text">..3.5.1. 全局符号和局部符号</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">3.5.2.</span> <span class="nav-text">..3.5.2. 外部符号和内部符号</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">3.5.3.</span> <span class="nav-text">..3.5.3. 和字符串表的关系</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">3.6.</span> <span class="nav-text">..3.6. 静态链接过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">3.7.</span> <span class="nav-text">..3.7. 动态链接过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#"><span class="nav-number">4.</span> <span class="nav-text">..4. 跟踪调测</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">4.1.</span> <span class="nav-text">..4.1. 测试源码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">4.2.</span> <span class="nav-text">..4.2. 位置有关的重定位分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">4.2.1.</span> <span class="nav-text">..4.2.1. 分析结论如下:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">4.2.2.</span> <span class="nav-text">..4.2.2. 系统源码参考:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">4.2.3.</span> <span class="nav-text">..4.2.3. 字符串数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">4.2.4.</span> <span class="nav-text">..4.2.4. 节信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">4.2.5.</span> <span class="nav-text">..4.2.5. text数据</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#"><span class="nav-number">4.3.</span> <span class="nav-text">..4.3. 位置无关的重定位分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">4.3.1.</span> <span class="nav-text">..4.3.1. 分析说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#"><span class="nav-number">4.3.2.</span> <span class="nav-text">..4.3.2. 全局数据访问代码分析</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">夏天</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">
    NexT.Gemini
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  


  




	





  





  






  





  

  

  

  
  


  

  

</body>
</html>
